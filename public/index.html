<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåç Global Chat</title>
<style>
/* ---------- Genel Stil ---------- */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;}

/* ---------- Containerlar ---------- */
.login-container,.profile-setup,.chat-container{background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);padding:40px;max-width:500px;width:90%;text-align:center;transition:all 0.3s;}
.hidden{display:none !important;}

/* ---------- Login ---------- */
.login-container h1{color:#333;margin-bottom:30px;font-size:32px;}
.form-group{margin-bottom:20px;text-align:left;}
.form-group label{display:block;margin-bottom:8px;color:#555;font-weight:600;}
.form-group input{width:100%;padding:12px;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:border 0.3s;}
.form-group input:focus{outline:none;border-color:#667eea;}
.send-code-btn,.verify-code-btn,.save-btn,.send-btn,.logout-btn{padding:15px;font-size:16px;font-weight:600;border:none;border-radius:10px;cursor:pointer;transition:all 0.3s;}
.send-code-btn,.verify-code-btn,.save-btn,.send-btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;width:100%;margin-top:10px;}
.logout-btn{background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:10px 20px;border-radius:20px;}
.logout-btn:hover{background:white;color:#667eea;}

/* ---------- Profil Setup ---------- */
.profile-setup h2{margin-bottom:25px;color:#333;}
.profile-setup input[type=color]{padding:0;width:50px;height:50px;border:none;cursor:pointer;}

/* ---------- Chat ---------- */
.chat-container .chat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
.chat-container .chat-header h2{margin-bottom:5px;}
.messages-area{height:60vh;overflow-y:auto;padding:20px;background:#f5f5f5;border-radius:15px;}
.message{display:flex;gap:15px;margin-bottom:20px;align-items:flex-start;}
.message-avatar{width:45px;height:45px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.message-content{flex:1;background:white;padding:12px 15px;border-radius:15px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.message-username{font-weight:600;font-size:15px;}
.message-time{font-size:12px;color:#999;}
.message-text{color:#333;line-height:1.5;word-wrap:break-word;}
.message-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:12px;color:#999;}
.typing-indicator{padding:10px 20px;font-size:14px;color:#667eea;font-style:italic;display:none;}
.chat-input-container{display:flex;gap:10px;padding:20px;}

/* ---------- Responsive ---------- */
@media(max-width:768px){.login-container,.profile-setup{padding:30px 20px;}.messages-area{height:50vh;}}
</style>
</head>
<body>

<!-- ---------- Login ---------- -->
<div class="login-container" id="loginScreen">
<h1>üåç Global Chat</h1>
<p style="margin-bottom:30px;color:#666;">E-posta ile giri≈ü yap</p>
<div class="form-group"><label>Email</label><input type="email" id="emailInput" placeholder="Emailinizi girin"></div>
<button class="send-code-btn" onclick="sendVerificationCode()">Doƒürulama Kodu G√∂nder</button>

<div class="hidden" id="codeSection">
<div class="form-group"><label>Doƒürulama Kodu</label><input type="text" id="codeInput" placeholder="Kodu girin"></div>
<button class="verify-code-btn" onclick="verifyCode()">Doƒürula ve Devam Et</button>
</div>
</div>

<!-- ---------- Profil Setup ---------- -->
<div class="profile-setup hidden" id="profileSetup">
<h2>Profilini Olu≈ütur</h2>
<div class="form-group"><label>Kullanƒ±cƒ± Adƒ±</label><input type="text" id="usernameInput" placeholder="Adƒ±nƒ± gir" maxlength="20"></div>
<div class="form-group"><label>ƒ∞sim Rengi</label><input type="color" id="colorInput" value="#4285F4"></div>
<div class="form-group"><label>Avatar URL</label><input type="text" id="avatarInput" placeholder="Avatar linki gir"></div>
<button class="save-btn" onclick="saveProfile()">Kaydet ve Devam Et</button>
</div>

<!-- ---------- Chat ---------- -->
<div class="chat-container hidden" id="chatScreen">
<div class="chat-header">
<div>
<h2 id="serverName">üåç Sunucu</h2>
<div><span id="onlineCount">0</span> ki≈üi √ßevrimi√ßi</div>
</div>
<button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
</div>

<div class="messages-area" id="messagesArea"></div>
<div class="typing-indicator" id="typingIndicator"><span id="typingUser"></span> yazƒ±yor...</div>

<div class="chat-input-container">
<input type="text" id="messageInput" class="message-input" placeholder="Mesajƒ±nƒ± yaz..." maxlength="500">
<button class="send-btn" onclick="sendMessage()">G√∂nder</button>
</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let socket,currentUser,currentServer;
let verificationCode=null;

function sendVerificationCode(){
const email=document.getElementById('emailInput').value.trim();
if(!email){alert('Email girin!');return;}
fetch('/api/send-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})})
.then(res=>res.json())
.then(data=>{if(data.success){verificationCode=data.code;document.getElementById('codeSection').classList.remove('hidden');alert('Kodu mailinize g√∂nderildi!');}else{alert('Kodu g√∂nderirken hata!');}});
}

function verifyCode(){
const inputCode=document.getElementById('codeInput').value.trim();
if(inputCode===verificationCode){currentUser={email:document.getElementById('emailInput').value.trim()};showProfileSetup();}else{alert('Kod hatalƒ±!');}
}

function showProfileSetup(){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('profileSetup').classList.remove('hidden');}

function saveProfile(){
const username=document.getElementById('usernameInput').value.trim();
const nameColor=document.getElementById('colorInput').value;
const avatar=document.getElementById('avatarInput').value.trim();
if(!username){alert('Kullanƒ±cƒ± adƒ± girin!');return;}
fetch('/api/profile-setup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,nameColor,avatar})})
.then(res=>res.json())
.then(data=>{if(data.success){currentUser=data.user;showChatScreen();}else{alert('Profil kaydedilemedi!');}});
}

function showChatScreen(){
document.getElementById('profileSetup').classList.add('hidden');
document.getElementById('chatScreen').classList.remove('hidden');
initChat();
}

function initChat(){
socket=io();
socket.emit('join-server',{userId:currentUser._id,serverId:'TR',username:currentUser.username,nameColor:currentUser.nameColor,avatar:currentUser.avatar});
socket.on('new-message',msg=>{renderMessages([msg]);});
socket.on('update-online',count=>{document.getElementById('onlineCount').innerText=count;});
socket.on('typing',user=>{showTyping(user);});
document.getElementById('messageInput').addEventListener('input',()=>{socket.emit('typing',{user:currentUser.username});});
}

function sendMessage(){
const msg=document.getElementById('messageInput').value.trim();
if(!msg)return;
socket.emit('send-message',{serverId:'TR',userId:currentUser._id,username:currentUser.username,message:msg,nameColor:currentUser.nameColor,avatar:currentUser.avatar,timestamp:new Date()});
document.getElementById('messageInput').value='';
}

function renderMessages(msgs){
const area=document.getElementById('messagesArea');
msgs.forEach(msg=>{
const div=document.createElement('div');div.classList.add('message');
const avatar=document.createElement('img');avatar.classList.add('message-avatar');avatar.src=msg.avatar||'https://via.placeholder.com/45';
const content=document.createElement('div');content.classList.add('message-content');
const header=document.createElement('div');header.classList.add('message-header');
const usernameSpan=document.createElement('span');usernameSpan.classList.add('message-username');usernameSpan.style.color=msg.nameColor||'#000';usernameSpan.innerText=msg.username;
const timeSpan=document.createElement('span');timeSpan.classList.add('message-time');timeSpan.innerText=new Date(msg.timestamp).toLocaleTimeString();
header.appendChild(usernameSpan);header.appendChild(timeSpan);
const textDiv=document.createElement('div');textDiv.classList.add('message-text');textDiv.innerText=msg.message;
content.appendChild(header);content.appendChild(textDiv);div.appendChild(avatar);div.appendChild(content);area.appendChild(div);
area.scrollTop=area.scrollHeight;
});
}

function showTyping(user){const indicator=document.getElementById('typingIndicator');if(user){document.getElementById('typingUser').innerText=user;indicator.style.display='block';}else{indicator.style.display='none';}}
function logout(){location.reload();}
</script>
</body>
</html>
