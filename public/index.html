<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ger√ßek Zamanlƒ± Mesajla≈üma</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; display:flex; align-items:center; justify-content:center;}
.login-container, .profile-setup{background:white;padding:40px 50px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:400px;width:90%; text-align:center;}
.login-container h1, .profile-setup h2{color:#333;margin-bottom:30px;}
.form-group{margin-bottom:20px;text-align:left;}
.form-group label{display:block;margin-bottom:8px;color:#555;font-weight:600;}
.form-group input{width:100%;padding:12px;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:border 0.3s;}
.form-group input:focus{outline:none;border-color:#667eea;}
.save-btn, .send-btn{width:100%;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:transform 0.3s;}
.save-btn:hover, .send-btn:hover{transform:translateY(-2px);}
.chat-container{display:none;width:100%;max-width:100vw;height:100vh;background:white;}
.chat-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;}
.messages-area{height:calc(100vh - 200px);overflow-y:auto;padding:20px;background:#f5f5f5;}
.message{display:flex;gap:15px;margin-bottom:20px;animation:slideIn 0.3s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.message-avatar{width:45px;height:45px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.message-content{flex:1;background:white;padding:12px 15px;border-radius:15px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.message-username{font-weight:600;font-size:15px;}
.message-time{font-size:12px;color:#999;}
.message-text{color:#333;line-height:1.5;word-wrap:break-word;}
.message-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:12px;color:#999;}
.typing-indicator{padding:10px 20px;font-size:14px;color:#667eea;font-style:italic;}
.message-input-area{padding:20px;background:white;border-top:1px solid #e0e0e0;display:flex;gap:10px;}
.message-input{flex:1;padding:15px;border:2px solid #ddd;border-radius:25px;font-size:16px;outline:none;transition:border 0.3s;}
.message-input:focus{border-color:#667eea;}
.logout-btn{background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:14px;transition:all 0.3s;}
.logout-btn:hover{background:white;color:#667eea;}
.hidden{display:none!important;}
.color-picker{display:flex;gap:15px;flex-wrap:wrap;margin-top:10px;}
.color-option{width:50px;height:50px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all 0.3s;}
.color-option:hover{transform:scale(1.1);}
.color-option.selected{border-color:white;box-shadow:0 0 0 3px #667eea;}
.photo-upload{position:relative;width:120px;height:120px;margin:0 auto 30px;border-radius:50%;overflow:hidden;border:4px solid #667eea;cursor:pointer;background:#f0f0f0;display:flex;align-items:center;justify-content:center;}
.photo-upload img{width:100%;height:100%;object-fit:cover;}
.photo-upload input{display:none;}
.photo-placeholder{font-size:48px;color:#999;}
@media(max-width:768px){.login-container,.profile-setup{padding:30px 20px;}.messages-area{height:calc(100vh-180px);}.message-input-area{padding:10px;}}
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-container" id="loginScreen">
    <h1>üåç Global Chat</h1>
    <p style="margin-bottom:30px;color:#666;">Email ile doƒürulama yaparak kaydol</p>
    <form id="emailForm">
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="emailInput" placeholder="Email girin" required>
        </div>
        <button type="submit" class="save-btn">Kod G√∂nder</button>
    </form>
</div>

<!-- Profile Setup Screen -->
<div class="profile-setup" id="profileSetup">
    <h2>Profilini Olu≈ütur</h2>
    
    <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
        <img id="profilePreview" style="display:none;">
        <span class="photo-placeholder" id="photoPlaceholder">üì∑</span>
        <input type="file" id="photoInput" accept="image/*,capture=camera">
    </div>

    <div class="form-group">
        <label>Kullanƒ±cƒ± Adƒ±</label>
        <input type="text" id="usernameInput" placeholder="Adƒ±nƒ± gir" maxlength="20">
    </div>

    <div class="form-group">
        <label>ƒ∞sim Rengi</label>
        <div class="color-picker">
            <div class="color-option selected" style="background:#4285F4;" data-color="#4285F4"></div>
            <div class="color-option" style="background:#EA4335;" data-color="#EA4335"></div>
            <div class="color-option" style="background:#FBBC05;" data-color="#FBBC05"></div>
            <div class="color-option" style="background:#34A853;" data-color="#34A853"></div>
            <div class="color-option" style="background:#9C27B0;" data-color="#9C27B0"></div>
            <div class="color-option" style="background:#FF6D00;" data-color="#FF6D00"></div>
        </div>
    </div>

    <button class="save-btn" onclick="saveProfile()">Kaydet ve Devam Et</button>
</div>

<!-- Chat Screen -->
<div class="chat-container" id="chatScreen">
    <div class="chat-header">
        <div class="server-info">
            <h2 id="serverName">üåç Sunucu</h2>
            <div class="online-count"><span id="onlineCount">0</span> ki≈üi √ßevrimi√ßi</div>
        </div>
        <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
    </div>

    <div class="messages-area" id="messagesArea"></div>
    <div class="typing-indicator hidden" id="typingIndicator">
        <span id="typingUser"></span> yazƒ±yor...
    </div>

    <div class="message-input-area">
        <input type="text" class="message-input" id="messageInput" placeholder="Mesajƒ±nƒ± yaz..." maxlength="500">
        <button class="send-btn" onclick="sendMessage()">G√∂nder</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let socket, currentUser=null, currentServer=null, selectedColor='#4285F4', selectedPhoto=null, messages=[], typingTimeout;

// Email ile doƒürulama formu
document.getElementById('emailForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const email=document.getElementById('emailInput').value.trim();
    if(!email)return alert("Email giriniz!");
    // Backend'e POST isteƒüi at, kod g√∂nder
    try{
        const res=await fetch('/api/send-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});
        if(res.ok){ alert("Doƒürulama kodu emailinize g√∂nderildi."); checkAuth(); }
        else alert("Hata olu≈ütu."); 
    }catch{alert("Sunucu hatasƒ±.");}
});

async function checkAuth(){
    try{
        const res=await fetch('/api/user');
        if(res.ok){
            const data=await res.json();
            currentUser=data.user;
            if(currentUser.username && currentUser.server) showChatScreen();
            else showProfileSetup();
        }else showLoginScreen();
    }catch{showLoginScreen();}
}

function showLoginScreen(){
    document.getElementById('loginScreen').style.display='block';
    document.getElementById('profileSetup').style.display='none';
    document.getElementById('chatScreen').style.display='none';
}

function showProfileSetup(){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('profileSetup').style.display='block';
    document.getElementById('chatScreen').style.display='none';
    detectCountry();
}

function showChatScreen(){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('profileSetup').style.display='none';
    document.getElementById('chatScreen').style.display='block';
    initializeChat();
}

// Color picker
document.querySelectorAll('.color-option').forEach(opt=>{
    opt.addEventListener('click',function(){
        document.querySelectorAll('.color-option').forEach(o=>o.classList.remove('selected'));
        this.classList.add('selected');
        selectedColor=this.dataset.color;
    });
});

// Foto y√ºkleme
document.getElementById('photoInput').addEventListener('change',function(e){
    const file=e.target.files[0];
    if(file){
        const reader=new FileReader();
        reader.onload=function(ev){ selectedPhoto=ev.target.result; document.getElementById('profilePreview').src=selectedPhoto; document.getElementById('profilePreview').style.display='block'; document.getElementById('photoPlaceholder').style.display='none';};
        reader.readAsDataURL(file);
    }
});

async function detectCountry(){
    try{ const res=await fetch('/api/detect-country'); const data=await res.json(); currentServer=data.country;}catch{currentServer='TR';}
}

// Profil kaydet
async function saveProfile(){
    const username=document.getElementById('usernameInput').value.trim();
    if(!username) return alert('Kullanƒ±cƒ± adƒ± giriniz!');
    try{
        const res=await fetch('/api/profile-setup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,profilePhoto:selectedPhoto,nameColor:selectedColor,country:currentServer})});
        const data=await res.json();
        currentUser=data.user; showChatScreen();
    }catch{alert("Profil kaydedilemedi!");}
}

// Chat fonksiyonlarƒ±
function initializeChat(){ 
    socket=io(); 
    document.getElementById('serverName').textContent=currentServer;
    socket.emit('join-server',{userId:currentUser._id,serverId:currentUser.server}); 
    loadMessages(); setupSocketListeners(); setupMessageInput();
}

async function loadMessages(){
    try{ const res=await fetch(`/api/messages/${currentUser.server}`); messages=await res.json(); renderMessages(); }catch(e){console.error(e);}
}

function setupSocketListeners(){
    socket.on('user-count',data=>{document.getElementById('onlineCount').textContent=data.count;});
    socket.on('new-message',msg=>{messages.push(msg); renderMessages(); if(msg.userId!==currentUser._id) socket.emit('message-seen',{messageId:msg._id,userId:currentUser._id});});
    socket.on('message-edited',({messageId,newMessage})=>{const m=messages.find(m=>m._id===messageId);if(m){m.message=newMessage;m.edited=true;renderMessages();}});
    socket.on('message-seen-update',({messageId,seenCount})=>{const e=document.querySelector(`[data-message-id="${messageId}"] .seen-count`);if(e)e.textContent=seenCount;});
    socket.on('user-typing',({username,isTyping})=>{const indicator=document.getElementById('typingIndicator');const userSpan=document.getElementById('typingUser'); if(isTyping){userSpan.textContent=username;indicator.classList.remove('hidden');}else{indicator.classList.add('hidden');}});
}

function setupMessageInput(){
    const input=document.getElementById('messageInput');
    input.addEventListener('keypress',e=>{if(e.key==='Enter') sendMessage();});
    input.addEventListener('input',()=>{
        clearTimeout(typingTimeout);
        socket.emit('typing',{serverId:currentUser.server,username:currentUser.username,isTyping:true});
        typingTimeout=setTimeout(()=>{socket.emit('typing',{serverId:currentUser.server,username:currentUser.username,isTyping:false});},1000);
    });
}

function sendMessage(){
    const input=document.getElementById('messageInput'); const message=input.value.trim();
    if(!message)return;
    socket.emit('send-message',{serverId:currentUser.server,userId:currentUser._id,username:currentUser.username,nameColor:currentUser.nameColor,profilePhoto:currentUser.profilePhoto,message});
    input.value='';
}

function renderMessages(){
    const container=document.getElementById('messagesArea'); container.innerHTML='';
    messages.forEach(msg=>{
        const div=document.createElement('div'); div.className='message'; div.dataset.messageId=msg._id;
        const time=new Date(msg.timestamp).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
        const canEdit=msg.userId===currentUser._id && (Date.now()-new Date(msg.timestamp))<120000;
        div.innerHTML=`<img src="${msg.profilePhoto}" class="message-avatar" alt="${msg.username}">
        <div class="message-content">
            <div class="message-header">
                <span class="message-username" style="color:${msg.nameColor}">${msg.username}</span>
                <span class="message-time">${time}</span>
            </div>
            <div class="message-text">${escapeHtml(msg.message)}</div>
            <div class="message-footer">
                <div>${msg.edited?'<span class="edit-indicator">d√ºzenlendi</span>':''}${canEdit?'<button onclick="editMessage(\''+msg._id+'\',\''+escapeHtml(msg.message)+'\')" style="background:none;border:none;color:#667eea;cursor:pointer;font-size:12px;">‚úèÔ∏è D√ºzenle</button>':''}</div>
                <div class="message-seen">‚úì‚úì - <span class="seen-count">${msg.seenBy?.length||0}</span></div>
            </div>
        </div>`;
        container.appendChild(div);
    });
    container.scrollTop=container.scrollHeight;
}

function editMessage(messageId,currentText){
    const newMsg=prompt('Mesajƒ± d√ºzenle:',currentText);
    if(newMsg && newMsg.trim()!==currentText) socket.emit('edit-message',{messageId,newMessage:newMsg.trim()});
}

function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}
function logout(){window.location.href='/logout';}

// Sayfa a√ßƒ±ldƒ±ƒüƒ±nda auth kontrol
checkAuth();
</script>
</body>
</html>
