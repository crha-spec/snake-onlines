<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Global Chat</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{width:100%;max-width:900px;background:#fff;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.2);overflow:hidden;display:flex}
.left{width:35%;padding:20px;background:#f5f5f5;border-right:1px solid #ddd}
.right{flex:1;padding:20px;display:flex;flex-direction:column}
h2{font-size:20px;margin-bottom:15px;color:#333}
.form-group{margin-bottom:15px}
label{display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:14px}
input[type="text"],input[type="email"],input[type="color"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
button{width:100%;padding:12px;background:linear-gradient(90deg,#667eea,#764ba2);color:#fff;border:0;border-radius:6px;font-weight:700;cursor:pointer;font-size:14px}
button:disabled{opacity:0.6;cursor:not-allowed}
button:hover:not(:disabled){opacity:0.9}
.hidden{display:none!important}
.messages{flex:1;overflow-y:auto;padding:15px;background:#f9f9f9;border-radius:8px;margin-bottom:15px}
.input-row{display:flex;gap:10px}
.input-row input{flex:1;padding:10px;border:1px solid #ddd;border-radius:6px}
.message{margin-bottom:15px;display:flex;gap:10px;align-items:flex-start}
.message.own{flex-direction:row-reverse}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
.bubble{background:#fff;padding:10px;border-radius:10px;max-width:70%;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
.message.own .bubble{background:#dcf8c6}
.meta{display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px}
.username{font-weight:700}
.time{color:#999}
.text{font-size:14px;word-wrap:break-word}
.seen{font-size:11px;color:#34b7f1;margin-top:5px;text-align:right}
.toast{position:fixed;top:20px;right:20px;background:#fff;padding:15px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:9999;animation:slideIn 0.3s}
.toast.success{border-left:4px solid #10b981}
.toast.error{border-left:4px solid #ef4444}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
@media(max-width:768px){
.container{flex-direction:column;height:100vh;border-radius:0}
.left{width:100%;border-right:0;border-bottom:1px solid #ddd}
.right{flex:1}
}
</style>
</head>
<body>

<div class="container">
<div class="left">
<div id="loginBox">
<h2>Giri≈ü</h2>
<div class="form-group">
<label>Email</label>
<input id="emailInput" type="email" placeholder="Email adresiniz"/>
</div>
<button id="sendCodeBtn">Kodu G√∂nder</button>

<div id="codeBox" class="hidden" style="margin-top:15px">
<div class="form-group">
<label>Doƒürulama Kodu</label>
<input id="codeInput" type="text" placeholder="6 haneli kod"/>
</div>
<button id="verifyBtn">Doƒürula</button>
</div>
</div>

<div id="profileBox" class="hidden">
<h2>Profil</h2>
<div class="form-group">
<label>Kullanƒ±cƒ± Adƒ±</label>
<input id="usernameInput" type="text" placeholder="Adƒ±nƒ±z"/>
</div>
<div class="form-group">
<label>Renk</label>
<input id="colorInput" type="color" value="#4285F4"/>
</div>
<button id="saveProfileBtn">Kaydet ve Sohbete Gir</button>
</div>
</div>

<div class="right">
<h2>üåç Global Chat <span style="font-size:14px;font-weight:normal;color:#999">Online: <span id="onlineCount">0</span></span></h2>
<div id="messages" class="messages"></div>
<div class="input-row">
<input id="messageInput" type="text" placeholder="Mesaj yazƒ±n..."/>
<button id="sendBtn">G√∂nder</button>
</div>
</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let socket=null,currentUser=null;

function showToast(msg,type='success'){
const t=document.createElement('div');
t.className='toast '+type;
t.textContent=(type==='success'?'‚úÖ ':'‚ùå ')+msg;
document.body.appendChild(t);
setTimeout(()=>t.remove(),3000);
}

async function postJSON(url,body){
const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
return r.json();
}

function escapeHtml(s){
return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// Send code
document.getElementById('sendCodeBtn').onclick=async()=>{
const email=document.getElementById('emailInput').value.trim();
if(!email)return showToast('Email girin','error');

const btn=document.getElementById('sendCodeBtn');
btn.disabled=true;
btn.textContent='G√∂nderiliyor...';

const res=await postJSON('/api/send-code',{email});

btn.disabled=false;
btn.textContent='Kodu G√∂nder';

if(res.success){
document.getElementById('codeBox').classList.remove('hidden');
showToast(res.devCode?'Kod: '+res.devCode:'Kod g√∂nderildi');
}else{
showToast(res.error||'Hata','error');
}
};

// Verify code
document.getElementById('verifyBtn').onclick=async()=>{
const email=document.getElementById('emailInput').value.trim();
const code=document.getElementById('codeInput').value.trim();
if(!email||!code)return showToast('Email ve kod gerekli','error');

const btn=document.getElementById('verifyBtn');
btn.disabled=true;
btn.textContent='Doƒürulanƒ±yor...';

const res=await postJSON('/api/verify-code',{email,code});

btn.disabled=false;
btn.textContent='Doƒürula';

if(res.success){
document.getElementById('loginBox').classList.add('hidden');
document.getElementById('profileBox').classList.remove('hidden');
showToast('Doƒürulama ba≈üarƒ±lƒ±');
}else{
showToast(res.error||'Kod hatalƒ±','error');
}
};

// Save profile
document.getElementById('saveProfileBtn').onclick=async()=>{
const username=document.getElementById('usernameInput').value.trim();
const color=document.getElementById('colorInput').value;
if(!username)return showToast('ƒ∞sim gerekli','error');

const btn=document.getElementById('saveProfileBtn');
btn.disabled=true;
btn.textContent='Kaydediliyor...';

const res=await postJSON('/api/profile-setup',{username,nameColor:color,country:'TR'});

btn.disabled=false;
btn.textContent='Kaydet ve Sohbete Gir';

if(res.success){
document.getElementById('profileBox').classList.add('hidden');
showToast('Profil kaydedildi');
startChat(res.user);
}else{
showToast(res.error||'Hata','error');
}
};

// Start chat
async function startChat(user){
const r=await fetch('/api/user');
if(!r.ok)return showToast('Oturum hatasƒ±','error');
currentUser=(await r.json()).user;

socket=io();
const serverId=currentUser.server||'TR';
socket.emit('join-server',{serverId});

// Load messages
const msgs=await fetch('/api/messages/'+serverId).then(r=>r.json());
msgs.forEach(renderMessage);
scroll();

socket.on('new-message',msg=>{
renderMessage(msg);
scroll();
if(msg.userId!==currentUser._id)socket.emit('message-seen',{messageId:msg._id,userId:currentUser._id});
});

socket.on('update-users',count=>document.getElementById('onlineCount').textContent=count);

socket.on('message-seen-update',d=>{
const el=document.querySelector(`[data-id="${d.messageId}"] .seen`);
if(el)el.textContent='‚úì‚úì '+d.seenCount;
});
}

// Render message
function renderMessage(msg){
const own=currentUser&&msg.userId===currentUser._id;
const div=document.createElement('div');
div.className='message '+(own?'own':'');
div.setAttribute('data-id',msg._id||'');

const avatar=msg.profilePhoto||`https://ui-avatars.com/api/?name=${encodeURIComponent(msg.username||'U')}`;
const time=new Date(msg.timestamp).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
const seen=msg.seenBy?.length||0;

div.innerHTML=`
<img class="avatar" src="${avatar}" onerror="this.src='https://ui-avatars.com/api/?name=U'"/>
<div class="bubble">
<div class="meta">
<span class="username" style="color:${msg.nameColor||'#333'}">${escapeHtml(msg.username||'Anonim')}</span>
<span class="time">${time}</span>
</div>
<div class="text">${escapeHtml(msg.message)}</div>
${own&&seen>0?`<div class="seen">‚úì‚úì ${seen}</div>`:''}
</div>`;

document.getElementById('messages').appendChild(div);
}

function scroll(){
const m=document.getElementById('messages');
m.scrollTop=m.scrollHeight;
}

// Send message
document.getElementById('sendBtn').onclick=sendMsg;
document.getElementById('messageInput').onkeydown=e=>{if(e.key==='Enter')sendMsg()};

function sendMsg(){
const text=document.getElementById('messageInput').value.trim();
if(!text)return showToast('Bo≈ü mesaj g√∂nderilemez','error');
if(!socket||!currentUser)return showToast('Sohbet ba≈ülatƒ±lmadƒ±','error');

socket.emit('send-message',{
serverId:currentUser.server||'TR',
userId:currentUser._id,
username:currentUser.username,
nameColor:currentUser.nameColor,
profilePhoto:currentUser.profilePhoto,
message:text
});
document.getElementById('messageInput').value='';
}

// Auto-login
window.onload=async()=>{
try{
const r=await fetch('/api/user');
if(r.ok){
const data=await r.json();
if(data.user){
document.getElementById('loginBox').classList.add('hidden');
document.getElementById('profileBox').classList.add('hidden');
startChat(data.user);
}
}
}catch(e){}
};
</script>
</body>
</html>
