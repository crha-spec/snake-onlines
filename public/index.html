<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Global Chat</title>
<style>
/* ---- Styles (responsive, readable) ---- */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{width:100%;max-width:920px;background:#fff;border-radius:14px;box-shadow:0 20px 40px rgba(0,0,0,0.15);overflow:hidden}
.left{width:40%;min-height:500px;padding:24px;background:#fafafa;border-right:1px solid #eee}
.right{width:60%;min-height:500px;padding:16px;display:flex;flex-direction:column}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
h2{font-size:18px;color:#222}
.small{font-size:13px;color:#666}
.form-group{margin-bottom:12px}
label{display:block;margin-bottom:6px;font-weight:600;color:#444}
input[type="text"],input[type="email"],input[type="color"],input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
button{padding:10px 14px;border-radius:8px;border:0;background:linear-gradient(90deg,#4f46e5,#9333ea);color:#fff;font-weight:700;cursor:pointer}
.button-ghost{background:transparent;border:1px solid #ddd;color:#333}
.hidden{display:none!important}
.messages{flex:1;overflow:auto;padding:12px;background:#f5f7fb;border-radius:8px}
.input-row{display:flex;gap:10px;padding:12px;border-top:1px solid #eee}
.message{display:flex;gap:10px;margin-bottom:12px;align-items:flex-start}
.avatar{width:44px;height:44px;border-radius:50%;background:#ddd;flex-shrink:0;object-fit:cover}
.bubble{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 8px rgba(10,10,10,0.06);max-width:78%}
.meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.username{font-weight:700}
.time{font-size:12px;color:#888}
@media(max-width:900px){.left{display:none}.right{width:100%}}
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;flex-wrap:wrap">
    <div class="left" id="leftPanel">
      <div class="header">
        <h2>Giriş / Doğrulama</h2>
        <div class="small">E-posta doğrulaması ile</div>
      </div>

      <div id="loginBox">
        <div class="form-group">
          <label>Email</label>
          <input id="emailInput" type="email" placeholder="you@example.com" />
        </div>
        <button id="sendCodeBtn">Kodu Gönder</button>

        <div id="codeBox" class="hidden" style="margin-top:12px">
          <div class="form-group">
            <label>Doğrulama Kodu</label>
            <input id="codeInput" type="text" placeholder="6 haneli kod" />
          </div>
          <button id="verifyBtn" class="button-ghost">Doğrula</button>
        </div>
      </div>

      <div id="profileBox" class="hidden">
        <h2>Profil Ayarları</h2>
        <div class="form-group">
          <label>Kullanıcı Adı</label>
          <input id="usernameInput" type="text" placeholder="Görünen adınız" />
        </div>
        <div class="form-group">
          <label>Avatar URL (opsiyonel)</label>
          <input id="avatarInput" type="text" placeholder="https://..." />
        </div>
        <div class="form-group">
          <label>İsim Rengi</label>
          <input id="colorInput" type="color" value="#4285F4" />
        </div>
        <button id="saveProfileBtn">Kaydet ve Sohbete Katıl</button>
      </div>

      <div id="infoBox" class="hidden" style="margin-top:12px">
        <p class="small">Not: SMTP ayarlarını .env ile yaptıysan gerçek mail gönderilir. Aksi halde kod konsola yazılır.</p>
      </div>
    </div>

    <div class="right">
      <div class="header">
        <div>
          <h2>🌍 Global Chat</h2>
          <div class="small">Konum bazlı odalar — sağ üstten çıkış yapabilirsin</div>
        </div>
        <div class="small">Çevrimiçi: <span id="onlineCount">0</span></div>
      </div>

      <div id="chatArea" style="display:flex;flex-direction:column;flex:1">
        <div id="messages" class="messages"></div>

        <div class="input-row">
          <input id="messageInput" type="text" placeholder="Mesaj yaz ve Enter'a bas" />
          <button id="sendBtn">Gönder</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* Client logic:
 - call /api/send-code  -> server emails code (or console.log)
 - call /api/verify-code -> server validates and creates session (server side)
 - call /api/profile-setup -> server fills user profile and returns user
 - then socket.io join-server with serverId (country-based)
 - send messages via socket.io, messages persisted server-side, broadcast to room
*/

let socket = null;
let currentUser = null;

async function postJSON(url, data) {
  const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
  return res.json();
}

// send code
document.getElementById('sendCodeBtn').addEventListener('click', async () => {
  const email = document.getElementById('emailInput').value.trim();
  if (!email) return alert('Email girin');
  const r = await postJSON('/api/send-code', { email });
  if (r.success) {
    document.getElementById('codeBox').classList.remove('hidden');
    document.getElementById('infoBox').classList.remove('hidden');
    alert('Kod gönderildi. E-postanı kontrol et.');
  } else {
    alert('Kod gönderilemedi: ' + (r.error || 'unknown'));
  }
});

// verify code
document.getElementById('verifyBtn').addEventListener('click', async () => {
  const email = document.getElementById('emailInput').value.trim();
  const code = document.getElementById('codeInput').value.trim();
  if (!email || !code) return alert('Email ve kod gerekli');
  const res = await postJSON('/api/verify-code', { email, code });
  if (res.success) {
    // server set session
    currentUser = { email };
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('profileBox').classList.remove('hidden');
    alert('Doğrulama başarılı — profil oluştur.');
  } else {
    alert('Kod hatalı veya süresi doldu.');
  }
});

// save profile
document.getElementById('saveProfileBtn').addEventListener('click', async () => {
  const username = document.getElementById('usernameInput').value.trim();
  const avatar = document.getElementById('avatarInput').value.trim();
  const nameColor = document.getElementById('colorInput').value;
  if (!username) return alert('Kullanıcı adı gerekli');

  const res = await postJSON('/api/profile-setup', { username, profilePhoto: avatar || undefined, nameColor, country: null });
  if (res.success) {
    currentUser = res.user;
    startChat();
    document.getElementById('profileBox').classList.add('hidden');
  } else {
    alert('Profil kaydedilemedi: ' + (res.error || 'server error'));
  }
});

// start chat after profile exists
async function startChat() {
  // connect socket
  socket = io();

  // join server: use user's server (from profile). If not present, fetch country and server assignment via /api/user
  const userResp = await fetch('/api/user');
  if (!userResp.ok) { alert('Oturum yok'); return; }
  const { user } = await userResp.json();
  currentUser = user;

  const serverId = user.server || 'TR';
  socket.emit('join-server', { userId: user._id, serverId, username: user.username, nameColor: user.nameColor, profilePhoto: user.profilePhoto });

  // fetch last messages
  const msgsRes = await fetch('/api/messages/' + encodeURIComponent(serverId));
  if (msgsRes.ok) {
    const msgs = await msgsRes.json();
    msgs.forEach(renderMessage);
  }

  // listeners
  socket.on('new-message', msg => renderMessage(msg));
  socket.on('update-users', count => document.getElementById('onlineCount').innerText = count);
  socket.on('message-edited', data => {
    // update DOM element if present (simple implementation)
    const el = document.querySelector(`[data-msg-id="${data.messageId}"] .message-text`);
    if (el) el.innerText = data.newMessage + ' (düzenlendi)';
  });
  socket.on('message-seen-update', data => {
    // optional: update seen count
    const el = document.querySelector(`[data-msg-id="${data.messageId}"] .seen-count`);
    if (el) el.innerText = data.seenCount;
  });

  // enable chat UI
  document.getElementById('chatArea').style.display = 'flex';
}

// send message
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('messageInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
  const txtEl = document.getElementById('messageInput');
  const text = txtEl.value.trim();
  if (!text) return;
  if (!socket || !currentUser) return alert('Oturum yok');

  const payload = {
    serverId: currentUser.server || 'TR',
    userId: currentUser._id,
    username: currentUser.username,
    nameColor: currentUser.nameColor,
    profilePhoto: currentUser.profilePhoto,
    message: text,
    timestamp: new Date().toISOString()
  };
  socket.emit('send-message', payload);
  txtEl.value = '';
}

function renderMessage(msg) {
  const messages = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = 'message';
  el.setAttribute('data-msg-id', msg._id || '');
  el.innerHTML = `
    <img class="avatar" src="${msg.profilePhoto || 'https://ui-avatars.com/api/?name='+encodeURIComponent(msg.username||'anon')}" />
    <div class="bubble">
      <div class="meta"><div class="username" style="color:${msg.nameColor||'#333'}">${escapeHtml(msg.username||'Anon')}</div><div class="time">${new Date(msg.timestamp).toLocaleTimeString()}</div></div>
      <div class="text">${escapeHtml(msg.message)}</div>
    </div>
  `;
  messages.appendChild(el);
  messages.scrollTop = messages.scrollHeight;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// quick logout (reload)
function logout() { fetch('/logout').then(()=>location.reload()); }

// optional: auto-detect country and show server selection in future
</script>
</body>
</html>
