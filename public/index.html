<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Global Chat — Tam Sürüm</title>
<link rel="stylesheet" href="/styles.css" />
<style>
/* Minimal inline styles (you can move to styles.css). Focus on message box prominence */
:root{--accent:#667eea}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,#eef2ff,#fff);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.app{width:100%;max-width:1100px;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.08);overflow:hidden;display:grid;grid-template-columns:360px 1fr;min-height:80vh}
.left{padding:22px;border-right:1px solid #eee;background:#fafbfd}
.right{display:flex;flex-direction:column}
h1{font-size:20px;margin-bottom:8px;color:#111}
.small{font-size:13px;color:#666}
.form-group{margin-bottom:12px}
label{display:block;margin-bottom:6px;font-weight:600;color:#333}
input[type="text"],input[type="email"],input[type="color"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb}
button{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#fff;padding:12px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
button.ghost{background:transparent;color:#333;border:1px solid #ddd}
.hidden{display:none!important}

/* Profile preview */
.profile-preview{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.profile-preview img{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid var(--accent)}

/* CHAT RIGHT */
.chat-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #eee}
.chat-main{flex:1;display:flex;flex-direction:column}
.messages{flex:1;padding:18px;overflow:auto;background:linear-gradient(#fff,#fbfdff)}
.message{display:flex;gap:12px;align-items:flex-start;margin-bottom:14px;max-width:80%}
.message.own{margin-left:auto}
.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid #eee}
.bubble{background:#fff;padding:10px 12px;border-radius:12px;box-shadow:0 6px 18px rgba(10,10,10,0.03)}
.bubble.own{background:linear-gradient(90deg,#dcfce7,#bbf7d0)}
.meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.username{font-weight:700}
.time{font-size:12px;color:#777}
.seen{font-size:12px;color:#0ea5a4;margin-top:6px;text-align:right}

/* input area prominent */
.input-area{display:flex;gap:10px;padding:14px;border-top:1px solid #eee;background:#fff}
.input-area input{flex:1;padding:12px;border-radius:999px;border:1px solid #e5e7eb}
.send-btn{padding:12px 18px;border-radius:999px}

/* responsive */
@media (max-width:920px){
  .app{grid-template-columns:1fr;min-height:100vh}
  .left{order:2;border-right:0;border-top:1px solid #eee}
  .right{order:1}
}
</style>
</head>
<body>
<div class="app">
  <div class="left">
    <h1>Giriş & Profil</h1>
    <p class="small">E-posta ile doğrulama -> profil oluştur -> bulunduğun ülke odasına bağlan</p>

    <div id="login-section">
      <div class="form-group">
        <label>Email</label>
        <input id="email" type="email" placeholder="you@example.com" />
      </div>
      <button id="send-code-btn">Doğrulama Kodu Gönder</button>

      <div id="verify-section" class="hidden" style="margin-top:12px">
        <div class="form-group">
          <label>Doğrulama Kodu</label>
          <input id="code" type="text" placeholder="6 haneli kod" />
        </div>
        <button id="verify-btn" class="ghost">Doğrula</button>
      </div>
    </div>

    <div id="profile-section" class="hidden" style="margin-top:18px">
      <div class="profile-preview">
        <img id="avatar-preview" src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff" alt="avatar" />
        <div>
          <div class="small">Profil Fotoğrafı (galeri)</div>
          <input id="avatar-file" type="file" accept="image/*" />
        </div>
      </div>

      <div class="form-group">
        <label>Kullanıcı Adı</label>
        <input id="username" type="text" placeholder="Görünen isim" />
      </div>

      <div class="form-group">
        <label>İsim Rengi</label>
        <input id="nameColor" type="color" value="#4285F4" />
      </div>

      <div class="form-group">
        <label>Konum izni (isteğe bağlı)</label>
        <div class="small">Tarayıcı izin verirse daha doğru ülke seçilir; vermezsen IP tabanlı fallback kullanılacak.</div>
      </div>

      <button id="save-profile-btn">Kaydet ve Sohbete Katıl</button>
    </div>

    <div id="info" style="margin-top:16px" class="small hidden"></div>
  </div>

  <div class="right">
    <div class="chat-header">
      <div>
        <div style="font-weight:800">🌍 Global Chat</div>
        <div class="small" id="roomLabel">Oda: -</div>
      </div>
      <div class="small">Çevrimiçi: <span id="onlineCount">0</span></div>
    </div>

    <div class="chat-main">
      <div id="messages" class="messages"></div>
      <div id="lastSeenInfo" style="padding:8px 16px;color:#666;font-size:13px"></div>
      <div class="input-area">
        <input id="messageInput" type="text" placeholder="Mesajınızı yazın..." maxlength="1000" />
        <button id="sendBtn" class="send-btn">Gönder</button>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* CLIENT SIDE: full-featured */
const API = '';
const socket = io();
let currentUser = null;
let currentRoom = null;

// Helpers
const $ = sel => document.querySelector(sel);
const el = (s) => document.createElement(s);

function showToast(msg, isErr=false) {
  alert(msg);
}

// --- Auth flow (send-code, verify-code)
$('#send-code-btn').addEventListener('click', async () => {
  const email = $('#email').value.trim();
  if (!email) return showToast('Email girin', true);
  $('#send-code-btn').disabled = true;
  $('#send-code-btn').textContent = 'Gönderiliyor...';
  const res = await fetch('/api/send-code', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email }) }).then(r=>r.json());
  $('#send-code-btn').disabled = false;
  $('#send-code-btn').textContent = 'Doğrulama Kodu Gönder';
  if (res.success) {
    $('#verify-section').classList.remove('hidden');
    $('#info').classList.remove('hidden');
    $('#info').textContent = res.devCode ? `DEV: Kod ${res.devCode} (sunucuda da loglandı)` : 'Kodu e-postana gönderildi.';
  } else showToast(res.error || 'Hata', true);
});

$('#verify-btn').addEventListener('click', async () => {
  const email = $('#email').value.trim();
  const code = $('#code').value.trim();
  if (!email || !code) return showToast('Email ve kod gerekli', true);
  $('#verify-btn').disabled = true;
  $('#verify-btn').textContent = 'Kontrol ediliyor...';
  const res = await fetch('/api/verify-code', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, code }) }).then(r=>r.json());
  $('#verify-btn').disabled = false;
  $('#verify-btn').textContent = 'Doğrula';
  if (res.success) {
    // show profile setup
    $('#login-section').classList.add('hidden');
    $('#profile-section').classList.remove('hidden');
    // pre-fill username and avatar if available via res.user
    if (res.user) {
      $('#username').value = res.user.username || (res.user.email ? res.user.email.split('@')[0] : '');
      $('#avatar-preview').src = res.user.profilePhoto || $('#avatar-preview').src;
    }
  } else {
    showToast(res.error || 'Kod hatalı', true);
  }
});

// avatar file -> base64 preview
$('#avatar-file').addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    $('#avatar-preview').src = ev.target.result;
    $('#avatar-preview').dataset.base64 = ev.target.result;
  };
  reader.readAsDataURL(f);
});

// Save profile (send base64 avatar + color + username + geolocation)
$('#save-profile-btn').addEventListener('click', async () => {
  const username = $('#username').value.trim();
  const nameColor = $('#nameColor').value || '#4285F4';
  const profilePhoto = $('#avatar-preview').dataset.base64 || $('#avatar-preview').src;

  if (!username) return showToast('Kullanıcı adı gerekli', true);
  $('#save-profile-btn').disabled = true;
  $('#save-profile-btn').textContent = 'Kaydediliyor...';

  // get geolocation if allowed
  let country = null;
  try {
    const pos = await new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject();
      navigator.geolocation.getCurrentPosition(resolve, () => reject(), { timeout: 5000 });
    });
    // use coordinates to call a public reverse geocode? We'll just set 'GEO' flag and let server IP fallback for server selection.
    country = null; // we won't send coordinates to server in this version, server will choose via IP or provided explicit
  } catch (e) {
    country = null;
  }

  const res = await fetch('/api/profile-setup', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ username, profilePhoto, nameColor, country })
  }).then(r=>r.json());

  $('#save-profile-btn').disabled = false;
  $('#save-profile-btn').textContent = 'Kaydet ve Sohbete Katıl';

  if (res.success) {
    currentUser = res.user;
    $('#profile-section').classList.add('hidden');
    startChat(res.user);
  } else showToast(res.error || 'Profil kaydedilemedi', true);
});

// Autologin: if session exists
window.addEventListener('load', async () => {
  try {
    const r = await fetch('/api/user');
    if (r.ok) {
      const { user } = await r.json();
      if (user) {
        currentUser = user;
        $('#login-section').classList.add('hidden');
        $('#profile-section').classList.add('hidden');
        startChat(user);
      }
    }
  } catch (e) { /* ignore */ }
});

// START CHAT: join room by geolocation or IP
async function startChat(user) {
  currentUser = user;
  $('#avatar-preview').src = user.profilePhoto || $('#avatar-preview').src;
  // determine country: prefer geolocation, else ipapi fallback
  let country = null;
  try {
    const pos = await new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject();
      navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 4000 });
    });
    // We could call reverse geocode service but avoid extra API keys — fallback to ip-based selection
    country = null;
  } catch (e) {
    country = null;
  }

  // Ask server for ip-based country via simple fetch (server uses headers)
  // We'll call ipapi.co to get country_name quickly (client-side)
  try {
    const ipres = await fetch('https://ipapi.co/json/').then(r=>r.json());
    country = ipres.country || ipres.country_name || null;
  } catch (e) {
    country = null;
  }

  // emit joinCountry (server will decide room)
  socket.emit('joinCountry', { country, username: user.username, profilePhoto: user.profilePhoto, nameColor: user.nameColor, userId: user._id });

  // set UI room label
  $('#roomLabel').textContent = `Oda: ${country || (user.server || 'TR')}`;

  // load recent messages for user's server
  const serverId = user.server || 'TR';
  $('#messages').innerHTML = '';
  const msgs = await fetch('/api/messages/' + encodeURIComponent(serverId)).then(r=>r.json());
  msgs.forEach(renderMessage);

  // socket listeners
  socket.on('new-message', (msg) => {
    // prevent duplicate if already exists
    if (document.querySelector(`[data-id="${msg._id}"]`)) return;
    renderMessage(msg);
    scrollToBottom();
    // if msg not from me, mark seen
    if (msg.userId !== currentUser._id) {
      socket.emit('message-seen', { messageId: msg._id, userId: currentUser._id });
    } else {
      // if it's my message, it appears as sent and we may want to auto-scroll
    }
  });

  socket.on('update-users', count => $('#onlineCount').textContent = count);
  socket.on('message-seen-update', d => {
    const el = document.querySelector(`[data-id="${d.messageId}"] .seen`);
    if (el) el.textContent = `✓✓ ${d.seenCount}`;
  });

  socket.on('message-edited', d => {
    const el = document.querySelector(`[data-id="${d.messageId}"] .text`);
    if (el) el.textContent = d.newMessage + ' (düzenlendi)';
  });
}

// RENDER message (bubble)
function renderMessage(msg) {
  const container = $('#messages');
  const wrapper = el('div');
  wrapper.className = 'message' + (msg.userId === currentUser._id ? ' own' : '');
  wrapper.setAttribute('data-id', msg._id || '');

  const avatar = el('img');
  avatar.className = 'avatar';
  avatar.src = msg.profilePhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.username||'U')}&background=667eea&color=fff`;
  avatar.onerror = () => avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.username||'U')}&background=667eea&color=fff`;

  const bubble = el('div');
  bubble.className = 'bubble' + (msg.userId === currentUser._id ? ' own' : '');

  const meta = el('div'); meta.className = 'meta';
  const nameSpan = el('div'); nameSpan.className = 'username'; nameSpan.textContent = msg.username || 'Anonim'; nameSpan.style.color = msg.nameColor || '#333';
  const timeSpan = el('div'); timeSpan.className = 'time'; timeSpan.textContent = new Date(msg.timestamp).toLocaleTimeString();

  meta.appendChild(nameSpan); meta.appendChild(timeSpan);

  const text = el('div'); text.className = 'text'; text.textContent = msg.message;

  bubble.appendChild(meta); bubble.appendChild(text);

  const seen = el('div'); seen.className = 'seen'; seen.textContent = msg.seenBy?.length ? `✓✓ ${msg.seenBy.length}` : '';
  bubble.appendChild(seen);

  wrapper.appendChild(avatar); wrapper.appendChild(bubble);
  $('#messages').appendChild(wrapper);
}

// send message
$('#sendBtn').addEventListener('click', sendMessage);
$('#messageInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

async function sendMessage() {
  const txt = $('#messageInput').value.trim();
  if (!txt) { showToast('Boş mesaj gönderilemez', true); return; }
  if (!currentUser) { showToast('Oturum açın', true); return; }

  const payload = {
    serverId: currentUser.server || 'TR',
    userId: currentUser._id,
    username: currentUser.username,
    nameColor: currentUser.nameColor,
    profilePhoto: currentUser.profilePhoto,
    message: txt
  };

  // disable UI briefly
  $('#sendBtn').disabled = true;
  $('#messageInput').disabled = true;

  socket.emit('send-message', payload);

  // rely on server's 'new-message' emit to render authoritative message (ensures id & db consistency)
  $('#messageInput').value = '';
  $('#messageInput').focus();
  $('#sendBtn').disabled = false;
  $('#messageInput').disabled = false;
}

function scrollToBottom() {
  const m = $('#messages');
  m.scrollTop = m.scrollHeight;
}
</script>
</body>
</html>
